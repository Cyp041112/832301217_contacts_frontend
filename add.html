<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>添加联系人</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            color: #343a40;
            font-family: "Microsoft YaHei", "Inter", sans-serif;
        }
        .form-container {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05);
            padding: 2rem;
            margin: 2rem auto;
            max-width: 800px;
        }
        .page-title {
            color: #2d3748;
            font-weight: 600;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 0.8rem;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .page-title i {
            color: #0d6efd;
        }
        .form-label {
            font-weight: 500;
            color: #495057;
        }
        /* 校验提示样式 */
        .form-feedback {
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none; /* 默认隐藏 */
        }
        .form-feedback.valid {
            color: #198754; /* 校验通过颜色 */
            display: block;
        }
        .form-feedback.invalid {
            color: #dc3545; /* 校验失败颜色 */
            display: block;
        }
        .btn-submit {
            background-color: #0d6efd;
            border-color: #0d6efd;
            padding: 0.5rem 1.5rem;
            font-weight: 500;
        }
        .btn-submit:disabled {
            background-color: #6c757d;
            border-color: #6c757d;
        }
        .btn-cancel {
            margin-left: 0.8rem;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="form-container">
            <h1 class="page-title">
                <i class="bi bi-person-plus-fill"></i> 添加联系人
            </h1>

            <!-- 添加联系人表单 -->
            <form id="addContactForm">
                <div class="row mb-3">
                    <label for="name" class="col-sm-2 col-form-label form-label">姓名</label>
                    <div class="col-sm-10">
                        <input type="text" class="form-control" id="name" name="name" required>
                        <div class="form-feedback" id="nameFeedback">请输入联系人姓名</div>
                    </div>
                </div>

                <!-- 手机号输入框（带正则校验） -->
                <div class="row mb-3">
                    <label for="phone" class="col-sm-2 col-form-label form-label">手机号</label>
                    <div class="col-sm-10">
                        <input type="tel" class="form-control" id="phone" name="phone" required>
                        <div class="form-feedback" id="phoneFeedback">
                            请输入11位中国大陆手机号（如：13800138000）
                        </div>
                    </div>
                </div>

                <!-- 邮箱输入框（带正则校验） -->
                <div class="row mb-3">
                    <label for="email" class="col-sm-2 col-form-label form-label">邮箱</label>
                    <div class="col-sm-10">
                        <input type="email" class="form-control" id="email" name="email">
                        <div class="form-feedback" id="emailFeedback">
                            请输入正确格式的邮箱（如：example@xxx.com，非必填）
                        </div>
                    </div>
                </div>

                <div class="row mb-3">
                    <label for="note" class="col-sm-2 col-form-label form-label">备注</label>
                    <div class="col-sm-10">
                        <textarea class="form-control" id="note" name="note" rows="3"></textarea>
                    </div>
                </div>

                <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-secondary btn-cancel" onclick="window.location.href='index.html'">
                        <i class="bi bi-arrow-left me-1"></i> 返回
                    </button>
                    <button type="submit" class="btn btn-primary btn-submit" id="submitBtn">
                        <i class="bi bi-save me-1"></i> 保存联系人
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 1. 定义正则表达式（符合中国大陆标准）
        const REGEX = {
            // 手机号：11位数字，以13/14/15/16/17/18/19开头
            phone: /^1[3-9]\d{9}$/,
            // 邮箱：支持字母、数字、下划线，域名支持多级后缀（如.com.cn）
            email: /^[a-zA-Z0-9_-]+@[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/
        };

        // 2. 获取表单元素
        const addForm = document.getElementById('addContactForm');
        const nameInput = document.getElementById('name');
        const phoneInput = document.getElementById('phone');
        const emailInput = document.getElementById('email');
        const submitBtn = document.getElementById('submitBtn');

        // 3. 实时校验函数
        function validateField(input, regex, feedbackEl, validMsg, invalidMsg) {
            const value = input.value.trim();
            const isRequired = input.hasAttribute('required');

            // 处理必填项为空的情况
            if (isRequired && value === '') {
                input.classList.add('is-invalid');
                input.classList.remove('is-valid');
                feedbackEl.className = 'form-feedback invalid';
                feedbackEl.textContent = invalidMsg || '此项为必填项';
                return false;
            }

            // 处理非必填项为空的情况（直接通过校验）
            if (!isRequired && value === '') {
                input.classList.remove('is-invalid', 'is-valid');
                feedbackEl.style.display = 'none';
                return true;
            }

            // 正则校验
            if (regex.test(value)) {
                input.classList.add('is-valid');
                input.classList.remove('is-invalid');
                feedbackEl.className = 'form-feedback valid';
                feedbackEl.textContent = validMsg || '格式正确';
                return true;
            } else {
                input.classList.add('is-invalid');
                input.classList.remove('is-valid');
                feedbackEl.className = 'form-feedback invalid';
                feedbackEl.textContent = invalidMsg || '格式错误';
                return false;
            }
        }

        // 4. 绑定输入事件（实时校验）
        // 姓名校验（非空）
        nameInput.addEventListener('input', () => {
            validateField(
                nameInput,
                /^.+$/, // 至少1个字符
                document.getElementById('nameFeedback'),
                '姓名格式正确',
                '请输入联系人姓名（不能为空）'
            );
        });

        // 手机号校验
        phoneInput.addEventListener('input', () => {
            validateField(
                phoneInput,
                REGEX.phone,
                document.getElementById('phoneFeedback'),
                '手机号格式正确',
                '请输入11位中国大陆手机号（如：13800138000）'
            );
        });

        // 邮箱校验（非必填）
        emailInput.addEventListener('input', () => {
            validateField(
                emailInput,
                REGEX.email,
                document.getElementById('emailFeedback'),
                '邮箱格式正确',
                '请输入正确格式的邮箱（如：example@xxx.com）'
            );
        });

        // 5. 表单提交校验
        addForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // 阻止默认提交

            // 手动触发所有字段校验
            const isNameValid = validateField(
                nameInput,
                /^.+$/,
                document.getElementById('nameFeedback'),
                '姓名格式正确',
                '请输入联系人姓名（不能为空）'
            );
            const isPhoneValid = validateField(
                phoneInput,
                REGEX.phone,
                document.getElementById('phoneFeedback'),
                '手机号格式正确',
                '请输入11位中国大陆手机号（如：13800138000）'
            );
            const isEmailValid = validateField(
                emailInput,
                REGEX.email,
                document.getElementById('emailFeedback'),
                '邮箱格式正确',
                '请输入正确格式的邮箱（如：example@xxx.com）'
            );

            // 所有字段校验通过后提交数据
            if (isNameValid && isPhoneValid && isEmailValid) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="bi bi-spinner fa-spin me-1"></i> 保存中...';

                try {
                    // 构造请求数据
                    const contactData = {
                        name: nameInput.value.trim(),
                        phone: phoneInput.value.trim(),
                        email: emailInput.value.trim() || null, // 空邮箱设为null
                        note: document.getElementById('note').value.trim() || null
                    };

                    // 发送添加请求（与原页面API地址一致）
                    const response = await fetch('http://localhost:5000/api/contacts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(contactData)
                    });

                    const result = await response.json();
                    if (result.status === 'success') {
                        alert('联系人添加成功！');
                        window.location.href = 'index.html'; // 跳转回列表页
                    } else {
                        alert(`添加失败：${result.msg || '未知错误'}`);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="bi bi-save me-1"></i> 保存联系人';
                    }
                } catch (error) {
                    console.error('添加联系人错误：', error);
                    alert('添加失败，请检查后端连接或网络！');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="bi bi-save me-1"></i> 保存联系人';
                }
            }
        });
    </script>
</body>
</html>